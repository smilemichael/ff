function init(){OpenLayers.ProxyHost="proxy.php?url=";OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";map=new OpenLayers.Map("map",{maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508.34),autoUpdateSize:true,transitionEffect:null,zoomMethod:null,projection:new OpenLayers.Projection("EPSG:4326"),units:"degrees",controls:[new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.Navigation({zoomWheelEnabled:true}),new OpenLayers.Control.ScaleLine]});map.viewBounds={county:new OpenLayers.Bounds(-13604530.147681711,4444768.802554563,-13534055.207602875,4498656.90749554),losAltos:new OpenLayers.Bounds(-13596708.942446,4491246.0376315,-13590593.980184,4494131.5354489),sanJose:new OpenLayers.Bounds(-13575212.778089,4482595.7357638,-13562982.853565,4489322.194252),santaClara:new OpenLayers.Bounds(-13583080.00662,4483885.4517777,-13570850.082096,4490611.9102659),milpitas:new OpenLayers.Bounds(-13575631.431899,4496367.3185259,-13563401.507375,4502138.3141607),paloAlto:new OpenLayers.Bounds(-13599848.424913,4499135.226219,-13593733.462651,4502020.7240364),sunnyvale:new OpenLayers.Bounds(-13591207.387007,4485362.4567691,-13578977.462483,4493569.8826801)};var e=new OpenLayers.Control.MousePosition({id:"mousePositionControl",element:"MousePosition"});map.addControl(e);var t=new OpenLayers.Control.LayerSwitcher({ascending:false});map.addControl(t);t.maximizeControl();var n=new OpenLayers.Layer.Google("&nbspGoogle Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:18,visibility:false,animationEnabled:true});var r=new OpenLayers.Layer.Google("&nbspGoogle Road",{type:google.maps.MapTypeId.ROADMAP,numZoomLevels:22,visibility:false,animationEnabled:true});var i=new OpenLayers.Layer.Google("&nbspGoogle Physical",{type:google.maps.MapTypeId.TERRAIN,visibility:false,animationEnabled:true});map.addLayers([i,r,n]);map.zoomToExtent(map.viewBounds["county"]);var s;var o=new OpenLayers.Layer.Vector("&nbspFlood Forecast Gages",{protocol:new OpenLayers.Protocol.HTTP({url:"http://10.25.5.112:8080/geoserver/scvwd/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=scvwd:ForecastStreamFlow&maxFeatures=50&outputFormat=json",format:new OpenLayers.Format.GeoJSON({})}),strategies:[new OpenLayers.Strategy.Fixed],displayInLayerSwitcher:false});var u=new OpenLayers.Style({cursor:"pointer",fillColor:"#FF0000",graphicName:"triangle",fillOpacity:.8,strokeColor:"#000000",strokeWidth:2,pointRadius:8,strokeDashStyle:"dot"});var a=new OpenLayers.Style({fillColor:"#CC0000",graphicName:"triangle",fillOpacity:.8,strokeColor:"#00FF00",strokeWidth:2,pointRadius:10,strokeDashStyle:"dot"});var f=new OpenLayers.StyleMap({"default":u,select:a});o.styleMap=f;map.addLayers([o]);s=new OpenLayers.Control.SelectFeature([o],{multiple:false,toggle:true,toggleKey:"ctrlKey",box:false,callbacks:{over:featureOver,out:hideTooltip}});map.addControl(s);s.activate();o.events.register("featureselected",this,forecast_selected_feature);o.events.register("featureunselected",this,forecast_unselected_feature)}function getFeatureLonLat(e){var t=new OpenLayers.LonLat(e.attributes.LONDD83,e.attributes.LATDD83);return t}function computeBBox(e){e.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));var t={left:e.lon-100,bottom:e.lat-window.innerHeight/.75,right:e.lon+100,top:e.lat+100};bounds=new OpenLayers.Bounds(t.left,t.bottom,t.right,t.top);return bounds}function featureOver(e){var t=e.attributes.STA_NAME;if(e.geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"){t+=" "+Math.round(e.geometry.getGeodesicLength(e.layer.map.baseLayer.projection)*.1)/100+"km"}var n=map.getControl("mousePositionControl").lastXy||{x:0,y:0};showTooltip(t,n.x,n.y)}function showTooltip(e,t,n){var r=$(window).width();var i=document.getElementById("tooltip");i.innerHTML=e;if(i.offsetWidth){var s=i.offsetWidth}else if(i.clip.width){var s=i.clip.width}n=n+16;t=t-s/4;if(t<2){t=2}else if(t+s>r){t=r-s-4}i.style.left=t+"px";i.style.top=n+"px";i.style.visibility="visible"}function hideTooltip(){document.getElementById("tooltip").style.visibility="hidden"}function forecast_selected_feature(e){var t="";var n=getFeatureLonLat(e.feature);$("#fcGageInfo, #fcPlot").empty();t+="<div class='fcGageInfo' id=\""+e.feature.fid+'">'+"<strong>Station Name: </strong>"+e.feature.attributes.STA_NAME+"<br/>"+"<strong>Station Number: </strong>"+e.feature.attributes.STA_NUMBER+"<br/>"+"<strong>ALERT ID: </strong>"+e.feature.attributes.ALERT_ID+"<br/>"+"<strong>Gage Type: </strong>"+e.feature.attributes.GAGE_TYPE+"<br/>"+"<strong>Major Watershed: </strong>"+e.feature.attributes.WTRSHD_MAJ+"<br/>"+"<strong>Longitude: </strong>"+e.feature.attributes.LONDD83+"<br/>"+"<strong>Latitude: </strong>"+e.feature.attributes.LATDD83+"<br/></div>";map.zoomToExtent(computeBBox(n));$("#fcGageInfo").html(t);$("#fcAnimatePanel").css("visibility","visible");$("#forecastInfo").tabs("option","active",0);$("#forecastInfo").tabs("enable",2);$("#forecastInfo").slideDown();stationNumber=e.feature.attributes.STA_NUMBER;selectedStation=stationObjects[stationNumber];if(selectedStation.spillLayersLoaded==false){selectedStation.getSpillLayers()}selectedStation.loadPlot();var r=$("#alertMe");if(r.length>0){$("#registrationControl").html(registrationControlHTML(selectedStation.stationNumber))}}function forecast_unselected_feature(e){previousStation=selectedStation;previousStation.plot.hc_chart.destroy();previousStation.hideSpillLayers();$("#forecastInfo").slideUp();selectedStation=null;$("#floodDemoSelect").val("default")}function registrationControlHTML(e){var t="You are registered to receive alerts for this flood plain.";var n="You are not registered to receive alerts for this flood plain.";var r="";var i="gage_"+e;var s;if(gages[i]==="T"){s=true}else{s=false}if(s){$("#alertGageRegistrationMessage").html(t);r+='<button class="btn btn-warning" id="btnUnAlertMe" data-gage-number="'+selectedStation.stationNumber+'">Unsubscribe</button>'+"<script>"+"$('#btnUnAlertMe').on(\"click\", function(){"+"unAlertMe();"+"});"+"</script>"}else{$("#alertGageRegistrationMessage").html(n);r+='<button class="btn btn-default" id="btnAlertMe" data-gage-number="'+selectedStation.stationNumber+'">ALERT Me!</button>'+"<script>"+"$('#btnAlertMe').on(\"click\", function(){"+"alertMe();"+"});"+"</script>"}return r}function initGages(){var e=["51_Cherry_100cfs","51_Cherry_200cfs","51_Cherry_300cfs","51_Cherry_400cfs","51_Cherry_500cfs","51_Cherry_600cfs","51_Cherry_700cfs","51_Cherry_800cfs","51_Cherry_900cfs","51_Cherry_1000cfs","51_Cherry_1100cfs","51_Cherry_1200cfs","51_Cherry_1300cfs","51_Cherry_1400cfs","51_Cherry_1500cfs","51_Cherry_1600cfs","51_Cherry_1700cfs","51_Cherry_1800cfs"];var t=["51_Jarvis_100cfs","51_Jarvis_200cfs","51_Jarvis_300cfs","51_Jarvis_400cfs","51_Jarvis_500cfs","51_Jarvis_600cfs","51_Jarvis_700cfs"];var n=["93_Ross2_100cfs","93_Ross2_200cfs"];var r=["93_Ross1_100cfs","93_Ross1_200cfs","93_Ross1_300cfs","93_Ross1_400cfs","93_Ross1_500cfs"];var i=["93_RossR_100cfs","93_RossR_200cfs","93_RossR_300cfs","93_RossR_400cfs","93_RossR_500cfs"];var s=["93_RossL_100cfs","93_RossL_200cfs"];var o=["117_WLL_280cfs","117_WLL_421cfs","117_WLL_561cfs","117_WLL_701cfs","117_WLL_841cfs","117_WLL_982cfs","117_WLL_1122cfs","117_WLL_1262cfs","117_WLL_1402cfs"];var u=["112_MiddlefieldL_100cfs","112_MiddlefieldL_208cfs"];var a=["112_MiddlefieldR_100cfs","112_MiddlefieldR_200cfs","112_MiddlefieldR_300cfs","112_MiddlefieldR_400cfs","112_MiddlefieldR_500cfs","112_MiddlefieldR_600cfs","112_MiddlefieldR_700cfs","112_MiddlefieldR_800cfs","112_MiddlefieldR_900cfs","112_MiddlefieldR_1000cfs","112_MiddlefieldR_1105cfs"];var f=["112_DS101L_100cfs","112_DS101L_200cfs","112_DS101L_300cfs","112_DS101L_400cfs","112_DS101L_500cfs","112_DS101L_600cfs","112_DS101L_700cfs","112_DS101L_800cfs","112_DS101L_836cfs"];var l=["112_DS101R_100cfs","112_DS101R_200cfs","112_DS101R_300cfs"];var c=["112_PopeChaucerL_100cfs","112_PopeChaucerL_200cfs","112_PopeChaucerL_300cfs","112_PopeChaucerL_415cfs"];var h=["112_PopeChaucerR_100cfs","112_PopeChaucerR_200cfs","112_PopeChaucerR_300cfs","112_PopeChaucerR_400cfs","112_PopeChaucerR_500cfs","112_PopeChaucerR_600cfs","112_PopeChaucerR_700cfs","112_PopeChaucerR_800cfs","112_PopeChaucerR_900cfs","112_PopeChaucerR_1000cfs","112_PopeChaucerR_1100cfs","112_PopeChaucerR_1179cfs"];var p=[100,200,300,400,500,600,700,800,900,1e3,1100,1200,1300,1400,1500,1600,1700,1800];var d={};for(var v=0;v<p.length;v++){d[p[v]]=null}var m={"2year":null,"5year":null,"10year":100,"25year":300,"50year":800,"100year":1800};var g=new SpillZone(100,1800,18,p,d,m,e,Cherry);var y=[100,200,300,400,500,600,700];var b={};for(var v=0;v<y.length;v++){b[y[v]]=null}var w={"2year":null,"5year":null,"10year":100,"25year":300,"50year":500,"100year":700};var E=new SpillZone(100,700,7,y,b,w,t,Jarvis);var S=["Cherry","Jarvis"];var x={Cherry:g,Jarvis:E};var T=new OpenLayers.Bounds(-13580402.729243,4466351.8865031,-13555942.880195,4482766.7383251);var N=new Plot("assets/js/plots/sta51/sta51Plot.js",sta51_histFlow,sta51_fcFlow);var C=new Gage(51,2,S,x,T,N);var k=[100,200,300,400,500];var L={};for(var v=0;v<k.length;v++){L[k[v]]=null}var A={"2year":null,"5year":null,"10year":null,"25year":null,"50year":200,"100year":500};var O=new SpillZone(100,500,5,k,L,A,r,Ross1);var M=[100,200];var _={};for(var v=0;v<M.length;v++){_[M[v]]=null}var D={"2year":null,"5year":null,"10year":null,"25year":null,"50year":null,"100year":200};var P=new SpillZone(100,200,2,M,_,D,n,Ross2);var H=[100,200];var B={};for(var v=0;v<H.length;v++){B[H[v]]=null}var j={"2year":null,"5year":null,"10year":null,"25year":null,"50year":null,"100year":200};var F=new SpillZone(100,200,2,H,B,j,s,RossL);var I=[100,200,300,400,500];var q={};for(var v=0;v<I.length;v++){q[I[v]]=null}var R={"2year":null,"5year":null,"10year":null,"25year":null,"50year":200,"100year":500};var U=new SpillZone(100,500,5,I,q,R,i,RossR);var z=["Ross1","Ross2","RossL","RossR"];var W={Ross1:O,Ross2:P,RossL:F,RossR:U};var X=new OpenLayers.Bounds(-13580402.729243,4466351.8865031,-13555942.880195,4482766.7383251);var V=new Plot("assets/js/plots/sta93/sta93Plot.js",sta93_histFlow,sta93_fcFlow);var $=new Gage(93,4,z,W,X,V);var J=[280,421,561,701,841,982,1122,1262,1402];var K={};for(var v=0;v<J.length;v++){K[I[v]]=null}var Q={"2year":421,"5year":701,"10year":841,"25year":1122,"50year":1262,"100year":1402};var G=new SpillZone(280,1402,9,J,K,Q,o,WLL);var Y=["WLL"];var Z={WLL:G};var et=new OpenLayers.Bounds(-13547493.618568,4451161.743461,-13535263.694044,4459369.169372);var tt=new Plot("assets/js/plots/sta117/sta117Plot.js",sta117_histFlow,sta117_fcFlow);var nt=new Gage(117,1,Y,Z,et,tt);var rt=[100,208];var it={};for(var v=0;v<rt.length;v++){it[rt[v]]=null}var st={"2year":null,"5year":null,"10year":null,"25year":null,"50year":null,"100year":208};var ot=new SpillZone(100,208,2,rt,it,st,u,MiddlefieldL);var ut=[100,200,300,400,500,600,700,800,900,1e3,1105];var at={};for(var v=0;v<ut.length;v++){at[ut[v]]=null}var ft={"2year":null,"5year":null,"10year":null,"25year":null,"50year":null,"100year":1105};var lt=new SpillZone(100,1105,11,ut,at,ft,a,MiddlefieldR);var ct=[100,200,300,400,500,600,700,800,836];var ht={};for(var v=0;v<ct.length;v++){ht[ct[v]]=null}var pt={"2year":null,"5year":null,"10year":null,"25year":700,"50year":800,"100year":836};var dt=new SpillZone(100,836,9,ct,ht,pt,f,DS101L);var vt=[100,200,300];var mt={};for(var v=0;v<vt.length;v++){mt[vt[v]]=null}var gt={"2year":null,"5year":null,"10year":null,"25year":200,"50year":300,"100year":300};var yt=new SpillZone(100,300,3,vt,mt,gt,l,DS101R);var bt=[100,200,300,415];var wt={};for(var v=0;v<bt.length;v++){wt[bt[v]]=null}var Et={"2year":null,"5year":null,"10year":null,"25year":100,"50year":300,"100year":415};var St=new SpillZone(100,415,4,bt,wt,Et,c,PopeChaucerL);var xt=[100,200,300,400,500,600,700,800,900,1e3,1100,1179];var Tt={};for(var v=0;v<xt.length;v++){Tt[xt[v]]=null}var Nt={"2year":null,"5year":null,"10year":null,"25year":300,"50year":900,"100year":1179};var Ct=new SpillZone(100,1179,12,xt,Tt,Nt,h,PopeChaucerR);var kt=["MiddlefieldL","MiddlefieldR","DS101L","DS101R","PopeChaucerL","PopeChaucerR"];var Lt={MiddlefieldL:ot,MiddlefieldR:lt,DS101L:dt,DS101R:yt,PopeChaucerL:St,PopeChaucerR:Ct};var At=new OpenLayers.Bounds(-13607788.276007,4489790.2122119,-13583328.426959,4506205.0640339);var Ot=new Plot("assets/js/plots/sta112/sta112Plot.js",sta112_histFlow,sta112_fcFlow);var Mt=new Gage(112,6,kt,Lt,At,Ot);stationObjects={51:C,93:$,117:nt,112:Mt}}function Plot(e,t,n){this.plotURL=e;this.hc_chart=null;this.historicData=t;this.forecastData=n;this.fcTimeIndex=new Array}function SpillZone(e,t,n,r,i,s,o,u){this.minSpill=e;this.maxSpill=t;this.numSpillLayers=n;this.spillRates=r;this.spillRatesToLayers=i;this.floodEvents=s;this.displayedLayers=[];this.forecastData=u;this.spillLayerNames=o}function Gage(e,t,n,r,i,s){this.stationNumber=e;this.numSpillZones=t;this.spillZoneNames=n;this.spillZones=r;this.spillExtent=i;this.spillLayersLoaded=false;this.plot=s}var map;$(document).ready(function(){initGages();$("#forecastInfo").hide();$("#forecastInfo").tabs();$("#forecastInfo").tabs("disable",3);$("#forecastInfo").css("visibility","visible");$("#floodDemoSelect").change(function(){var e=$("#floodDemoSelect").val();if(e!="default"){selectedStation.displayFloodEvent(e)}else{selectedStation.hideAllSpillLayers()}});$("#sbViewSelect").change(function(){map.zoomToExtent(map.viewBounds[$("#sbViewSelect option:selected").val()],true);$("#sbViewSelect").val("default")})});var stationObjects;var spill_vector_style=new OpenLayers.Style({fillColor:"#0033CC",fillOpacity:.5,strokeColor:"#0000FF",strokeWidth:0});var spill_vector_style_map=new OpenLayers.StyleMap({"default":spill_vector_style});Plot.prototype.getFCCurrIndex=function(e){for(var t=0;t<this.forecastData.length;t++){if(this.forecastData[t][0]==undefined){if(this.forecastData[t].x>=e){return t}}else{if(this.forecastData[t][0]>=e){return t}}}};Plot.prototype.getSeries=function(e){var t=this.getFCCurrIndex(e);var n=[e,0];this.historicData[this.historicData.length]=n;this.forecastData.splice(0,t);this.forecastData.splice(0,0,n);this.hc_chart.addSeries({name:"Historic",color:"#0000FF",data:this.historicData});this.hc_chart.addSeries({name:"Forecast",color:"#FF0000",data:this.forecastData});for(var r=0;r<this.forecastData.length;r++){this.fcTimeIndex.push(this.forecastData[r][0])}return t};SpillZone.prototype.getLayerFromSpillRate=function(e){if(e>=this.maxSpill){return this.spillRatesToLayers[this.maxSpill]}for(var t=0;t<this.numSpillLayers-1;t++){currSpillRate=this.spillRates[t];nextSpillRate=this.spillRates[t+1];if(e>=currSpillRate&&e<nextSpillRate){return this.spillRatesToLayers[currSpillRate]}}};Gage.prototype.displaySpill=function(e){for(var t=0;t<this.numSpillZones;t++){var n=this.spillZoneNames[t];var r=this.spillZones[n];prevSpillLayer=r.displayedLayers.pop();if(prevSpillLayer!=undefined){prevSpillLayer.setVisibility(false)}if(e<r.forecastData.length){var i=r.forecastData[e][1]}if(i>=r.minSpill&&i!=-1){spillLayer=r.getLayerFromSpillRate(i);spillLayer.setVisibility(true);r.displayedLayers.push(spillLayer);map.zoomToExtent(this.spillExtent,true)}}};Gage.prototype.hideSpillLayers=function(){for(var e=0;e<this.numSpillZones;e++){var t=this.spillZoneNames[e];var n=this.spillZones[t];if(n.displayedLayers.length>0){for(var r=0;r<n.displayedLayers.length;r++){n.displayedLayers[r].setVisibility(false)}n.displayedLayers=[]}}};Gage.prototype.getSpillLayers=function(){for(var e=0;e<this.numSpillZones;e++){var t=this.spillZoneNames[e];var n=this.spillZones[t];for(var r=0;r<n.numSpillLayers;r++){n.spillRatesToLayers[n.spillRates[r]]=new OpenLayers.Layer.Vector(n.spillLayerNames[r],{protocol:new OpenLayers.Protocol.HTTP({url:"http://10.25.5.112:8080/geoserver/scvwd/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=scvwd:"+n.spillLayerNames[r]+"&outputFormat=json&mode=download",format:new OpenLayers.Format.GeoJSON({extractStyles:true,extractAttributes:true})}),strategies:[new OpenLayers.Strategy.Fixed({preload:true})],visibility:false,displayInLayerSwitcher:false});n.spillRatesToLayers[n.spillRates[r]].styleMap=spill_vector_style_map;map.addLayer(n.spillRatesToLayers[n.spillRates[r]])}}this.spillLayersLoaded=true};Gage.prototype.displayFloodEvent=function(e){this.hideSpillLayers();for(var t=0;t<this.numSpillZones;t++){var n=this.spillZoneNames[t];var r=this.spillZones[n];var i=r.floodEvents[e];if(i!=null){var s=r.spillRatesToLayers[i];s.setVisibility(true);r.displayedLayers.push(s)}}map.zoomToExtent(this.spillExtent,true)};Gage.prototype.downloadKML=function(){layerString="&layers=";numLayersInStr=0;for(var e=0;e<this.numSpillZones;e++){spillZoneName=this.spillZoneNames[e];spillZone=this.spillZones[spillZoneName];if(spillZone.displayedLayers.length>0){if(numLayersInStr>0){layerString+=","}layerName=spillZone.displayedLayers[0].name;layerString+=layerName;numLayersInStr++}}if(numLayersInStr>0){var t="controllers/downloadKML.php?station="+this.stationNumber+layerString;window.location=t}else{alert("No spills currently on map.")}};Gage.prototype.loadPlot=function(){$.getScript(this.plot.plotURL).done(function(e,t){console.log(t);selectedStation.plot.hc_chart=chart;var n=(new Date).getTime()-288e5;selectedStation.plot.hc_chart.xAxis[0].addPlotLine({value:n,color:"red",width:2,color:"#000000",dashStyle:"shortDash",label:{text:"Current Time (PST)",rotation:0,style:{color:"#333333",fontWeight:"bold"}},id:"now-line"});selectedStation.plot.getSeries(n);for(var r=0;r<this.numSpillZones;r++){var i=selectedStation.spillZoneNames[r];var s=selectedStation.spillZones[i];s.forecastData.splice(0,0,[n,0])}}).fail(function(e,t,n){console.log("Triggered ajaxError handler. e: "+n+"\njqxhr: "+e.statusCode())})}